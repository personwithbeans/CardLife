name: Arduino Build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Install CLI
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      # Install necessary cores
      - name: Install ESP32 Core
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32

      # Install libraries via Library Manager
      - name: Install Arduino Libraries
        run: |
          arduino-cli lib install "M5Cardputer"
      # Install M5Stack ESP32 Core (required for Cardputer)
      - name: Update index and add ESP32 core
        run: |
          arduino-cli core update-index --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core install esp32:esp32
      # Example: Install external GitHub libraries
      # - name: Clone External Libraries
      #   run: |
      #     mkdir -p libraries
      #     git clone https://github.com/YourLibrary/ExtraLib ./libraries/ExtraLib

      # Auto-generate version file
      - name: Generate version header
        run: |
          echo "#pragma once" > version.h
          echo "#define OS_VERSION \"${{ github.sha }}\"" >> version.h
          echo "#define BUILD_NUMBER ${{ github.run_number }}" >> version.h

      # Build firmware
      - name: Compile sketch
        run: |
          arduino-cli compile --fqbn esp32:esp32:esp32 CardLife.ino
